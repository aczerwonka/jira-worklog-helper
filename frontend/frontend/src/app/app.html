<!-- Jira Worklog Application -->
<div class="app-container">
  <!-- Top Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-content">
      <div class="navbar-brand">
        <h1>Worklog Tracker</h1>
      </div>
      <div class="navbar-user">
        <button type="button" class="btn-prefixes" (click)="openPrefixesModal()">PREFIXES</button>
        <button
          type="button"
          (click)="togglePrefixesEnabled()"
          [attr.aria-pressed]="prefixesEnabled()"
          style="margin-left:12px;padding:6px 10px;border-radius:6px;border:none;cursor:pointer;color:#fff;font-weight:600;font-size:14px"
          [style.background]="prefixesEnabled() ? '#10B981' : '#6B7280'"
          [title]="prefixesEnabled() ? 'Prefixes enabled' : 'Prefixes disabled'"
        >
          <span *ngIf="prefixesEnabled()">Prefixes: ON</span>
          <span *ngIf="!prefixesEnabled()">Prefixes: OFF</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Workspace -->
  <div class="workspace">
    <!-- Left Column: Calendar & History -->
    <div class="left-column">
      <div class="section-header">
        <h2>Worklog History</h2>
        <span class="badge">Last 7 days</span>
      </div>

      <div class="history-container" *ngIf="history().length > 0; else noHistory">
        <div class="history-item" *ngFor="let item of history()" (click)="selectHistoryItem(item)">
          <div class="history-item-ticket">
            <span class="ticket-key">{{ item.ticketKey }}</span>
          </div>
          <div class="history-item-content">
            <p class="summary">{{ item.summary }}</p>
            <div class="item-meta" *ngIf="item.timeSpentSeconds">
              <span class="time">{{ item.timeSpentSeconds ? (item.timeSpentSeconds / 3600).toFixed(1) : '0.0' }} hours</span>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noHistory>
        <div class="empty-state">
          <p>No worklogs in the last 7 days</p>
        </div>
      </ng-template>

      <!-- Calendar Section -->
      <div class="calendar-section">
        <div class="calendar-header">
          <h2>Calendar</h2>
          <div class="calendar-controls">
            <button (click)="setCalendarMode('day')" [class.active]="calendarMode() === 'day'" class="mode-btn">Day</button>
            <button (click)="setCalendarMode('week')" [class.active]="calendarMode() === 'week'" class="mode-btn">Week</button>
            <button (click)="setCalendarMode('month')" [class.active]="calendarMode() === 'month'" class="mode-btn">Month</button>
          </div>
        </div>

        <div class="calendar-nav">
          <button (click)="prevPeriod()" class="nav-btn">&larr;</button>
          <span class="period-label">
            {{ calendarMode() === 'month' ? getMonthYear() : (calendarMode() === 'week' ? getWeekRange() : (currentDate() | date:'MMM d, yyyy':'' :'en-US')) }}
          </span>
          <button (click)="nextPeriod()" class="nav-btn">&rarr;</button>
        </div>

        <div [ngSwitch]="calendarMode()" class="calendar-view">
          <!-- Month View -->
          <div *ngSwitchCase="'month'" class="month-grid">
            <div class="weekday-header">
              <div class="weekday">Mon</div>
              <div class="weekday">Tue</div>
              <div class="weekday">Wed</div>
              <div class="weekday">Thu</div>
              <div class="weekday">Fri</div>
              <div class="weekday">Sat</div>
              <div class="weekday">Sun</div>
            </div>
            <div class="days-grid">
              <div *ngFor="let dayObj of calendarDays()" class="day-cell"
                   (click)="selectCalendarDate(dayObj.date)"
                   [class.other-month]="dayObj.date.getMonth() !== currentDate().getMonth()"
                   [style.backgroundColor]="isFormDate(dayObj.date) ? 'rgba(59,130,246,0.08)' : null"
                   [style.border]="isFormDate(dayObj.date) ? '1px solid rgba(59,130,246,0.35)' : null"
                   [style.borderRadius]="isFormDate(dayObj.date) ? '6px' : null">
                <div class="day-number">{{ dayObj.date.getDate() }}</div>
                <!--worklogs badges-->
                <div class="day-total-badge" *ngIf="sumWorkTime(dayObj.worklogs)">
                  <span class="badge total-time">{{ sumWorkTime(dayObj.worklogs) }}</span>
                </div>
                <div class="day-worklogs" *ngIf="dayObj.worklogs && dayObj.worklogs.length > 0">
                  <div class="worklog-badge" *ngFor="let worklog of dayObj.worklogs" (click)="fillFormFromWorklog(worklog); $event.stopPropagation()">
                    <span class="badge-ticket">{{ displayTicket(worklog) }}</span>
                    <span class="badge-time">{{ displayWorkTime(worklog) }}</span>
                    <div class="badge-comment" *ngIf="worklog.comment">{{ worklog.comment }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Week View -->
          <div *ngSwitchCase="'week'" class="week-view">
              <div class="weekday-header">
                <div class="weekday">Mon</div>
                <div class="weekday">Tue</div>
                <div class="weekday">Wed</div>
                <div class="weekday">Thu</div>
                <div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
                <div class="weekday">Sun</div>
              </div>
              <div class="week-days">
                <div *ngFor="let dayObj of getWeekDays()" class="week-day-card"
                   (click)="selectCalendarDate(dayObj.date)"
                   [style.backgroundColor]="isFormDate(dayObj.date) ? 'rgba(59,130,246,0.08)' : null"
                   [style.border]="isFormDate(dayObj.date) ? '1px solid rgba(59,130,246,0.35)' : null"
                   [style.borderRadius]="isFormDate(dayObj.date) ? '6px' : null">
                <div class="week-day-header">
                  <div class="day-name">{{ dayObj.date | date:'EEE':'' :'en-US' }}</div>
                  <div class="day-date">{{ dayObj.date | date:'MMM d':'' :'en-US' }}</div>
                </div>
                 <div class="week-day-worklogs">
                  <div *ngIf="dayObj.worklogs && dayObj.worklogs.length > 0; else emptyDay">
                    <div class="week-worklog-item" *ngFor="let worklog of dayObj.worklogs" (click)="fillFormFromWorklog(worklog); $event.stopPropagation()">
                      <span class="work-ticket">{{ displayTicket(worklog) }}</span>
                      <span class="work-time">{{ displayWorkTime(worklog) }}</span>
                      <div class="work-comment" *ngIf="worklog.comment">{{ worklog.comment }}</div>
                    </div>
                  </div>
                  <ng-template #emptyDay>
                    <div class="empty-day">No worklogs</div>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>

          <!-- Day View -->
          <div *ngSwitchCase="'day'" class="day-view">
            <div *ngIf="calendarDays().length > 0; else noDay" class="day-detail">
              <div class="day-detail-header">
                <h3>{{ calendarDays()[0].date | date:'EEEE, MMMM d, yyyy':'' :'en-US' }}</h3>
              </div>
              <div class="day-worklogs-list">
                <div *ngIf="calendarDays()[0].worklogs && calendarDays()[0].worklogs.length > 0; else noDayWorklogs">
                  <div class="day-worklog-entry" *ngFor="let worklog of calendarDays()[0].worklogs" (click)="fillFormFromWorklog(worklog); $event.stopPropagation()">
                    <div class="entry-ticket">{{ displayTicket(worklog) }}</div>
                    <div class="entry-time">{{ displayWorkTime(worklog) }}</div>
                    <div class="entry-summary">{{ displaySummary(worklog) }}</div>
                  </div>
                </div>
                <ng-template #noDayWorklogs>
                  <div class="empty-state">No worklogs on this day</div>
                </ng-template>
              </div>
              <button (click)="selectCalendarDate(calendarDays()[0].date)" class="btn-select-day">
                Select this date
              </button>
            </div>

            <ng-template #noDay>
              <div class="weekday">Mon</div>
              <div class="weekday">Tue</div>
              <div class="weekday">Wed</div>
              <div class="weekday">Thu</div>
              <div class="weekday">Fri</div>
              <div class="weekday">Sat</div>
              <div class="weekday">Sun</div>
            </ng-template>
          </div> <!-- end .day-view -->

        </div> <!-- end .calendar-view -->
      </div> <!-- end .calendar-section -->
    </div> <!-- end .left-column -->

    <!-- Right Column: Action Panel (Form) -->
    <div class="right-column">
      <!-- New Favorites Component -->
      <app-favorites (favoriteSelected)="selectFavoriteWorklog($event)"></app-favorites>

      <div class="action-panel">
        <div class="panel-header">
          <h2>Log Work</h2>
        </div>

        <form [formGroup]="worklogForm" class="worklog-form">
          <!-- Favorites Section -->
          <div class="form-section">
            <div class="favorites-grid" *ngIf="favorites().length > 0">
              <button
                type="button"
                *ngFor="let ticket of favorites()"
                (click)="selectFavorite(ticket)"
                [class.active]="selectedTicket() === ticket.key"
                class="favorite-chip"
              >
                <span class="chip-key">{{ ticket.key }}</span>
                <span class="chip-label">{{ ticket.label }}</span>
              </button>
            </div>
          </div>

          <!-- Ticket Input -->
          <div class="form-section">
            <label for="ticketKey" class="form-label">Ticket Number</label>
            <input
              id="ticketKey"
              type="text"
              formControlName="ticketKey"
              placeholder="e.g., DUM-123"
              (change)="onTicketKeyChange($any($event.target).value)"
              (input)="onTicketKeyInput($any($event.target).value)"
              class="form-input"
            />
            <!-- always render placeholder to avoid layout jump; loader is absolutely positioned inside it -->
            <div class="summary-preview">
              <div class="loading-text" [class.visible]="isLoadingSummary()">Loading...</div>
              <div class="summary-text">{{ selectedTicketSummary() }}</div>
            </div>
          </div>

          <!-- Activity Description -->
          <div class="form-section">
            <label for="comment" class="form-label">Activity Description</label>
            <!-- Active prefixes badges -->
            <div class="active-prefixes" *ngIf="activePrefixes().length > 0">
              <span
                class="prefix-badge"
                *ngFor="let p of activePrefixes()"
                [class.removed]="removedPrefixes().includes(p)"
              >
                [{{ p }}]
                <button
                  type="button"
                  class="prefix-remove"
                  (click)="removeActivePrefix(p)"
                >
                  <label>X</label>
                </button>
              </span>
            </div>
            <textarea
              id="comment"
              formControlName="comment"
              placeholder="Describe what you worked on..."
              class="form-textarea"
              (focus)="fetchSuggestedPrefixes()"
              (input)="onCommentInput($any($event.target).value)"
            ></textarea>
          </div>

          <!-- Suggested Prefixes START-->
          <div class="form-section" *ngIf="constantPrefixes().length > 0">
             <label class="section-label">Available Prefixes</label>
             <div class="tag-cloud">
               <button
                 type="button"
                 *ngFor="let prefix of constantPrefixes()"
                 (click)="toggleConstantPrefix(prefix)"
                 [class.active]="selectedConstantPrefixes().includes(prefix)"
                 class="tag-chip"
               >
                 {{ prefix }}
               </button>
             </div>
           </div>
          <!-- Suggested Prefixes END-->
          <!-- Date Picker -->
          <div class="form-section">
            <label for="date" class="form-label">Date</label>
            <div class="date-controls">
              <input
                id="date"
                type="date"
                formControlName="date"
                class="form-input date-input"
              />
              <button
                type="button"
                (click)="setToday()"
                class="btn-today"
              >
                Today
              </button>
            </div>
          </div>

          <!-- Duration Picker -->
          <div class="form-section">
            <label class="section-label">Duration</label>

            <!-- new two-column control: hours | minutes -->
             <div class="duration-grid">
              <div class="duration-column hours-column">
                <div class="column-label">Hours</div>
                <div class="duration-options">
                  <button
                    type="button"
                    *ngFor="let hour of hourOptions"
                    (click)="setSelectedHour(hour)"
                    [class.active]="getSelectedHour() === hour"
                    class="duration-btn"
                  >
                    {{ hour }}h
                  </button>
                </div>
              </div>

              <div class="duration-column minutes-column">
                <div class="column-label">Minutes</div>
                <div class="duration-options">
                  <button
                    type="button"
                    *ngFor="let minute of minuteOptions"
                    (click)="setSelectedMinute(minute)"
                    [class.active]="getSelectedMinute() === minute"
                    class="duration-btn"
                  >
                    {{ minute }}m
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Save Button -->
          <button
            type="button"
            (click)="saveWorklog()"
            [disabled]="isLoadingSave() || worklogForm.invalid"
            class="btn-primary"
          >
            <span *ngIf="!isLoadingSave()">Save Worklog</span>
            <span *ngIf="isLoadingSave()">Saving...</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast container (right-bottom) -->
  <div id="toast-container" aria-live="polite" style="position:fixed;right:16px;bottom:16px;z-index:110;display:flex;flex-direction:column;gap:8px;align-items:flex-end;"></div>

  <!-- simple prefixes modal -->
  <div class="modal-backdrop" *ngIf="showPrefixesModal()" (click)="closePrefixesModal()"></div>
  <div class="modal" *ngIf="showPrefixesModal()">
    <div class="modal-header">
      <h3>Manage Prefixes</h3>
      <button type="button" class="modal-close" (click)="closePrefixesModal()">Close</button>
    </div>
    <div class="modal-body">
      <div class="modal-controls">
        <label><input type="checkbox" [checked]="prefixesEnabled()" (change)="togglePrefixesEnabled()" /> Prefixes enabled</label>
        <button type="button" (click)="startAddPrefix()">Add prefix</button>
      </div>

      <div class="prefixes-table">
        <table>
          <thead><tr><th>Type (keyword)</th><th>Prefix</th><th>Enabled</th><th>Actions</th></tr></thead>
          <tbody>
            <tr *ngFor="let p of prefixesList()">
              <td *ngIf="editingPrefix?.id !== p.id">{{p.type}}</td>
              <td *ngIf="editingPrefix?.id === p.id"><input [(ngModel)]="editingPrefix.type"/></td>
              <td *ngIf="editingPrefix?.id !== p.id">{{p.prefix}}</td>
              <td *ngIf="editingPrefix?.id === p.id"><input [(ngModel)]="editingPrefix.prefix"/></td>
              <td *ngIf="editingPrefix?.id !== p.id">{{p.enabled}}</td>
              <td *ngIf="editingPrefix?.id === p.id"><input type="checkbox" [(ngModel)]="editingPrefix.enabled"/></td>
              <td>
                <button *ngIf="editingPrefix?.id !== p.id" type="button" (click)="editPrefix(p)">Edit</button>
                <button *ngIf="editingPrefix?.id === p.id" type="button" (click)="saveEditingPrefix()">Save</button>
                <button type="button" (click)="deletePrefix(p)">Delete</button>
                <button *ngIf="editingPrefix?.id === p.id" type="button" (click)="cancelEditing()">Cancel</button>
              </td>
            </tr>
            <tr *ngIf="addingPrefix">
              <td><input [(ngModel)]="newPrefix.type"/></td>
              <td><input [(ngModel)]="newPrefix.prefix"/></td>
              <td><input type="checkbox" [(ngModel)]="newPrefix.enabled"/></td>
              <td>
                <button type="button" (click)="createPrefix()">Create</button>
                <button type="button" (click)="cancelAdd()">Cancel</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
     </div>
  </div>
</div>
